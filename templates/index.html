<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Pipefy Process Intelligence</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üìä Pipefy Process Intelligence</h1>
            <p class="subtitle">Dashboard de An√°lise de Dados</p>
        </header>

        <!-- KPIs principais -->
        <section class="kpi-section">
            <div class="kpi-card">
                <div class="kpi-icon">üë•</div>
                <div class="kpi-content">
                    <h3>{{ metrics.total_respondentes }}</h3>
                    <p>Respondentes</p>
                </div>
            </div>
            <div class="kpi-card success">
                <div class="kpi-icon">‚úÖ</div>
                <div class="kpi-content">
                    <h3>{{ metrics.taxa_utilidade }}%</h3>
                    <p>Taxa de Utilidade</p>
                </div>
            </div>
            <div class="kpi-card info">
                <div class="kpi-icon">‚ö°</div>
                <div class="kpi-content">
                    <h3>{{ metrics.taxa_engajamento }}%</h3>
                    <p>Engajamento Alto</p>
                </div>
            </div>
            <div class="kpi-card warning">
                <div class="kpi-icon">üòä</div>
                <div class="kpi-content">
                    <h3>{{ metrics.taxa_facilidade }}%</h3>
                    <p>Facilidade de Uso</p>
                </div>
            </div>
        </section>

        <!-- Gr√°ficos principais -->
        <section class="charts-section">
            <div class="chart-container">
                <div class="card">
                    <h2>Tempo de Uso do Pipefy</h2>
                    <canvas id="tempoUsoChart"></canvas>
                </div>
                <div class="card">
                    <h2>Frequ√™ncia de An√°lises</h2>
                    <canvas id="frequenciaChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="card">
                    <h2>Facilidade de Uso</h2>
                    <canvas id="facilidadeChart"></canvas>
                </div>
                <div class="card">
                    <h2>Utilidade Geral</h2>
                    <canvas id="utilidadeChart"></canvas>
                </div>
            </div>

            <div class="chart-container full-width">
                <div class="card">
                    <h2>Top 10 Departamentos</h2>
                    <canvas id="departamentosChart"></canvas>
                </div>
            </div>

            <div class="chart-container full-width">
                <div class="card">
                    <h2>Objetivos da √Årea</h2>
                    <canvas id="objetivosChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Coment√°rios -->
        <section class="comments-section">
            <div class="card">
                <h2>üí¨ Coment√°rios sobre Facilidade ({{ metrics.total_comentarios_facilidade }} total)</h2>
                <div class="comments-list">
                    {% for comentario in comentarios_facilidade %}
                    <div class="comment-item">
                        <span class="comment-icon">üí≠</span>
                        <p>"{{ comentario }}"</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="card">
                <h2>üí° Coment√°rios sobre Utilidade ({{ metrics.total_comentarios_utilidade }} total)</h2>
                <div class="comments-list">
                    {% for comentario in comentarios_utilidade %}
                    <div class="comment-item">
                        <span class="comment-icon">‚ú®</span>
                        <p>"{{ comentario }}"</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>Dashboard gerado a partir dos dados de Process Intelligence</p>
        </footer>
    </div>

    <script>
        // Configura√ß√£o global dos gr√°ficos
        Chart.defaults.font.family = "'Inter', 'Segoe UI', sans-serif";
        Chart.defaults.color = '#666';

        // Cores consistentes
        const colors = {
            primary: '#4F46E5',
            success: '#10B981',
            warning: '#F59E0B',
            danger: '#EF4444',
            info: '#3B82F6',
            purple: '#8B5CF6',
            pink: '#EC4899'
        };

        const colorPalette = [
            colors.primary,
            colors.success,
            colors.warning,
            colors.info,
            colors.purple,
            colors.pink,
            '#14B8A6',
            '#F97316',
            '#84CC16',
            '#06B6D4'
        ];

        // Fun√ß√£o para criar gr√°fico de pizza
        function createPieChart(ctx, labels, data, colors) {
            return new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Fun√ß√£o para criar gr√°fico de barras horizontal
        function createBarChart(ctx, labels, data, color) {
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade',
                        data: data,
                        backgroundColor: color,
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        // Carregar dados e criar gr√°ficos
        async function loadCharts() {
            try {
                // Tempo de Uso
                const tempoData = await fetch('/api/tempo-uso').then(r => r.json());
                createPieChart(
                    document.getElementById('tempoUsoChart'),
                    tempoData.map(d => d.label),
                    tempoData.map(d => d.value),
                    colorPalette
                );

                // Frequ√™ncia
                const freqData = await fetch('/api/frequencia').then(r => r.json());
                createPieChart(
                    document.getElementById('frequenciaChart'),
                    freqData.map(d => d.label),
                    freqData.map(d => d.value),
                    colorPalette
                );

                // Facilidade
                const facilData = await fetch('/api/facilidade').then(r => r.json());
                createPieChart(
                    document.getElementById('facilidadeChart'),
                    facilData.map(d => d.label),
                    facilData.map(d => d.value),
                    [colors.success, colors.info, colors.warning, colors.danger, '#991B1B']
                );

                // Utilidade
                const utilData = await fetch('/api/utilidade').then(r => r.json());
                createPieChart(
                    document.getElementById('utilidadeChart'),
                    utilData.map(d => d.label),
                    utilData.map(d => d.value),
                    [colors.success, colors.info, colors.warning, colors.danger, '#991B1B']
                );

                // Departamentos
                const deptData = await fetch('/api/departamentos').then(r => r.json());
                createBarChart(
                    document.getElementById('departamentosChart'),
                    deptData.map(d => d.label),
                    deptData.map(d => d.value),
                    colors.primary
                );

                // Objetivos
                const objData = await fetch('/api/objetivos').then(r => r.json());
                createBarChart(
                    document.getElementById('objetivosChart'),
                    objData.map(d => d.label),
                    objData.map(d => d.value),
                    colors.purple
                );

            } catch (error) {
                console.error('Erro ao carregar gr√°ficos:', error);
            }
        }

        // Carregar quando a p√°gina estiver pronta
        document.addEventListener('DOMContentLoaded', loadCharts);
    </script>
</body>
</html>
